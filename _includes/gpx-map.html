<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.5.1/gpx.min.js"></script>

<div id="{{ include.mapid }}" style="height: 500px; margin-top: 1rem;"></div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    console.log("Initializing map: {{ include.mapid }}");
    var map = L.map('{{ include.mapid }}');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    var gpxUrl = '{{ include.gpxfile }}';
    console.log("Loading GPX from:", gpxUrl);

    new L.GPX(gpxUrl, {
      async: true,
      marker_options: {
        startIconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.5.1/pin-icon-start.png',
        endIconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.5.1/pin-icon-end.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.5.1/pin-shadow.png'
      }
    }).on('loaded', function(e) {
      console.log("GPX loaded:", e);
      map.fitBounds(e.target.getBounds());
    }).on('error', function(e) {
      console.error("GPX load error:", e);
    }).addTo(map);
  });
</script>